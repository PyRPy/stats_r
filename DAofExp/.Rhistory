# load packages
require(foreign)
require(MASS)
# EDA
cdata <- read.dta("https://stats.idre.ucla.edu/stat/data/crime.dta")
summary(cdata)
# Using robust regression analysis
summary(ols <- lm(crime ~ poverty + single, data = cdata))
opar <- par(mfrow = c(2,2), oma = c(0, 0, 1.1, 0))
plot(ols, las = 1)
par(opar)
cdata[c(9, 25, 51), 1:2]
d1 <- cooks.distance(ols)
r <- stdres(ols)
a <- cbind(cdata, d1, r)
a[d1 > 4/51, ]
rabs <- abs(r)
a <- cbind(cdata, d1, r, rabs)
asorted <- a[order(-rabs), ]
asorted[1:10, ]
summary(rr.huber <- rlm(crime ~ poverty + single, data = cdata))
hweights <- data.frame(state = cdata$state, resid = rr.huber$resid, weight = rr.huber$w)
hweights2 <- hweights[order(rr.huber$w), ]
hweights2[1:15, ]
rr.bisquare <- rlm(crime ~ poverty + single, data=cdata, psi = psi.bisquare)
summary(rr.bisquare)
biweights <- data.frame(state = cdata$state, resid = rr.bisquare$resid, weight = rr.bisquare$w)
biweights2 <- biweights[order(rr.bisquare$w), ]
biweights2[1:15, ]
setwd("~/GitHub/stats_r/DAofExp")
uav.data <- read.table("Data/uav.txt", header=T)
uav.data = within(uav.data, {fA = factor(A); fW = factor(W);
fB = factor(B); fC = factor(C) })
head(uav.data, 3)
str(uav.data)
# Least squares ANOVA
# Set contrast options for correct lsmeans and contrasts
options(contrasts = c("contr.sum", "contr.poly"))
model1 <- aov(Time ~ fA*fB*fC + Error(fA:fW), data=uav.data)
summary(model1)
# Compare 2 levels of fA pairwise
library(lsmeans)
lsmA <- lsmeans(model1, ~ fA)
summary(contrast(lsmA, method="pairwise"), infer=c(T,T))
# Compare 2 levels of fA pairwise given each fB:fC combination
library(lsmeans)
lsmAgBC <- lsmeans(model1, ~ fA | fC:fB)
summary(contrast(lsmAgBC, method="pairwise", adjust="none"),
infer=c(T,T), level=0.99)
# Table 19.26, p751
uav3.data <- read.table("Data/uav3.txt", header=T)
uav3.data <- within(uav3.data,
{fA = factor(A); fW = factor(W); fB = factor(B) })
head(uav3.data, 3)
# ANOVA: full model
# Set contrast options for correct lsmeans and contrasts
options(contrasts = c("contr.sum", "contr.poly"))
model1 <- aov(Time ~ fA + fB + fA:fB + Error(fA:fW), data=uav3.data)
summary(model1)
# Multiple comparisons
library(lsmeans)
lsmA.aov <- lsmeans(model1, ~ fA)
summary(contrast(lsmA.aov, method="pairwise"),
infer=c(T,T), side="two-sided")
lsmAB.aov <- lsmeans(model1, ~ fA:fB)
summary(contrast(lsmAB.aov, method="pairwise", adjust="tukey"),
infer=c(T,T), side="two-sided")
# Table 19.27, p752
# ReML: full model
library(lmerTest)
model2 <- lmer(Time ~ fA + fB + fA:fB + (1|fA:fW), data=uav3.data)
anova(model2)
summary(model2) # Gives fA:fW variance component estimate approx 0
# Multiple comparisons
# Detach then reload lsmeans, to avoid issues from its masking by lmerTest
detach("package:lsmeans", unload=TRUE)
library(lsmeans)
lsmA2 <- lsmeans(model2, ~ fA)
summary(contrast(lsmA2, method="pairwise"),
infer=c(T,T), side="two-sided")
lsmAB.reml <- lsmeans(model2, ~ fA:fB)
summary(contrast(lsmAB.reml, method="pairwise", adjust="tukey"),
infer=c(T,T), side="two-sided")
# ANOVA: reduced model--without fW
model3 <- aov(Time ~ fA + fB + fA:fB, data=uav3.data)
summary(model3)
# Multiple comparisons
lsmA.aov2 <- lsmeans(model3, ~ fA)
summary(contrast(lsmA.aov2, method="pairwise"),
infer=c(T,T), side="two-sided")
lsmAB.aov2 <- lsmeans(model3, ~ fA:fB)
summary(contrast(lsmAB.aov2, method="pairwise", adjust="tukey"),
infer=c(T,T), side="two-sided")
# Table 19.28, p754, intra-block analysis
oats.data <- read.table("Data/oats.txt", header=T)
oats.data <- within(oats.data, {fBlock = factor(Block);
fWP = factor(WP); fA = factor(A); fB = factor(B) })
# Reduce data so level of A constitute a BIBD
oats2.data <- subset(oats.data,
!(fA == 0 & (fBlock == 3 | fBlock == 5))
& !(fA == 1 & (fBlock == 1 | fBlock == 4))
& !(fA == 2 & (fBlock == 2 | fBlock == 6)) )
# Intra-block analysis: ANOVA, fixed block effects
options(contrasts = c("contr.sum", "contr.poly")) # For correct lsmeans
model1 <- aov(y ~ fBlock + fA + fB + fA:fB + Error(fWP:fBlock),
data=oats2.data)
summary(model1)
# Dunnett's Method for A: ANOVA approach
library(lsmeans)
lsmA1 <-  lsmeans(model1, ~ fA)
set.seed(19831957)
summary(contrast(lsmA1, method="trt.vs.ctrl", adjust="mvt"),
infer=c(T,T), level=0.99)
# Code from text p753
# Intra-block analysis: ReML, fixed block effects
library(lmerTest)
model2 <- lmer(y ~ fBlock + fA + fB + fA:fB + (1|fWP:fBlock),
data=oats2.data)
anova(model2)
# Table 19.29, p755
# Recovering inter-block information: ReML, random block effects
model3 <- lmer(y ~ fA + fB + fA:fB + (1|fBlock) + (1|fWP:fBlock),
data=oats2.data)
anova(model3)
# Dunnett's Method for A: ReML approach
# Detach then reload lsmeans, to avoid issues from its masking by lmerTest
detach("package:lsmeans", unload=TRUE)
library(lsmeans)
lsmA3 <- lsmeans(model3, ~ fA)
set.seed(19831957)
summary(contrast(lsmA3, method="trt.vs.ctrl", adjust="mvt"),
infer=c(T,T), level=0.99)
